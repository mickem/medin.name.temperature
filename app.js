!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("homey"),require("athom-api")):"function"==typeof define&&define.amd?define(["homey","athom-api"],t):"object"==typeof exports?exports.library=t(require("homey"),require("athom-api")):e.library=t(e.homey,e["athom-api"])}(global,(function(e,t){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(t,i){t.exports=e},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const o=i(2),s=r(i(0)),d=i(3),a=i(4),u=i(5),h=e=>new Promise(t=>setTimeout(t,e)),c={maxTemperature:22,minTemperature:18},l=[];let m={maxTemperature:c.maxTemperature,minTemperature:c.minTemperature};class g extends s.default.App{constructor(e){super(e),this.api=void 0,this.triggers=new a.Triggers,this.zones=new u.Zones(this),this.actions=new d.Actions({setMaxTemperature(e){},setMinTemperature(e){}})}onInit(){return n(this,void 0,void 0,(function*(){this.getApi();const e=s.default.ManagerSettings.get("settings")||c;m.minTemperature=e.minTemperature||c.minTemperature,m.maxTemperature=e.maxTemperature||c.maxTemperature,console.log(`Allowed temperature span: ${m.minTemperature} - ${m.maxTemperature}`),this.zonesIgnored=s.default.ManagerSettings.get("zonesIgnored")||[],this.zonesNotMonitored=s.default.ManagerSettings.get("zonesNotMonitored")||[],this.devicesIgnored=s.default.ManagerSettings.get("devicesIgnored")||[],yield this.zones.updateDevices(this.zonesIgnored,this.zonesNotMonitored,this.devicesIgnored),console.log(`Config: ${this.zonesIgnored}, ${this.zonesNotMonitored}, ${this.devicesIgnored}`),s.default.ManagerSettings.on("set",e=>n(this,void 0,void 0,(function*(){"settings"===e?(m=s.default.ManagerSettings.get("settings"),console.log(`Allowed temperature span: ${m.minTemperature} - ${m.maxTemperature}`)):"zonesIgnored"===e?(this.zonesIgnored=s.default.ManagerSettings.get("zonesIgnored"),console.log(`Ignored zones: ${this.zonesIgnored}`),yield this.updateDeviceConfig()):"zonesNotMonitored"===e?(this.zonesNotMonitored=s.default.ManagerSettings.get("zonesNotMonitored"),console.log(`Zones not monitored: ${this.zonesNotMonitored}`),yield this.updateDeviceConfig()):"devicesIgnored"===e&&(this.devicesIgnored=s.default.ManagerSettings.get("devicesIgnored"),console.log(`Ignored devices: ${this.devicesIgnored}`),yield this.updateDeviceConfig())}))),this.triggers.register(),this.actions.register(),this.triggers.disable(),yield this.enumerateDevices(),this.triggers.enable()}))}getTriggers(){return this.triggers}getMinTemp(){return m.minTemperature}getMaxTemp(){return m.maxTemperature}getZones(){return this.zones.getAll()}getDevices(){return n(this,void 0,void 0,(function*(){return(yield this.getApi()).devices.getDevices()}))}updateDeviceConfig(){return n(this,void 0,void 0,(function*(){yield this.zones.updateDevices(this.zonesIgnored,this.zonesNotMonitored,this.devicesIgnored)}))}getApi(){return n(this,void 0,void 0,(function*(){return void 0===this.api&&(this.api=yield o.HomeyAPI.forCurrentHomey()),this.api}))}enumerateDevices(){return n(this,void 0,void 0,(function*(){const e=yield this.getApi();e.devices.on("device.create",e=>n(this,void 0,void 0,(function*(){const t=yield this.waitForDevice(e,12);t&&(yield this.addDevice(t))}))),e.devices.on("device.delete",e=>n(this,void 0,void 0,(function*(){yield this.zones.removeDeviceById(e)})));const t=yield e.devices.getDevices();for(const e in t){const i=yield this.waitForDevice(t[e],12);i&&(yield this.addDevice(i))}}))}waitForDevice(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getApi(),n=yield i.devices.getDevice({id:e.id});return n.ready?n:(yield h(1e3),t>0?this.waitForDevice(e,t--):(console.log("Found Device, not ready:    "+n.name),l.push(n.name),!1))}))}addDevice(e){return n(this,void 0,void 0,(function*(){if(!("measure_temperature"in e.capabilitiesObj))return;const t=this.zones.addZone(e.zone,e.zoneName);yield t.addDevice(e),e.makeCapabilityInstance("measure_temperature",i=>n(this,void 0,void 0,(function*(){yield t.updateTemp(e.id,i)})))}))}}e.exports=g},function(e,i){e.exports=t},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(i(0));t.Actions=class{constructor(e){this.handler=e,this.SetMaxTemperature=new r.default.FlowCardAction("SetMaxTemperature"),this.SetMinTemperature=new r.default.FlowCardAction("SetMinTemperature")}register(){this.SetMaxTemperature.register().on("run",(e,t,i)=>{console.log("TemperatureManager:setMaxTemp"+e),this.handler.setMaxTemperature(0),i(null,!0)}),this.SetMinTemperature.register().on("run",(e,t,i)=>{console.log("TemperatureManager:SetMinTemperature"+e),this.handler.setMinTemperature(0),i(null,!0)})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(i(0));t.Triggers=class{constructor(){this.MaxTemperatureChanged=new o.default.FlowCardTrigger("MaxTemperatureChanged"),this.MinTemperatureChanged=new o.default.FlowCardTrigger("MinTemperatureChanged"),this.TemperatureChanged=new o.default.FlowCardTrigger("TemperatureChanged"),this.TooCold=new o.default.FlowCardTrigger("TooCold"),this.TooWarm=new o.default.FlowCardTrigger("TooWarm"),this.enabled=!0}register(){this.TemperatureChanged.register(),this.MaxTemperatureChanged.register(),this.MinTemperatureChanged.register(),this.TooCold.register(),this.TooWarm.register()}enable(){console.log("Enabling all triggers"),this.enabled=!0}disable(){console.log("Disabling all triggers"),this.enabled=!1}onTempUpdated(e,t){return n(this,void 0,void 0,(function*(){this.enabled&&(yield this.TemperatureChanged.trigger({temperature:t,zone:e}))}))}onMaxUpdated(e,t,i){return n(this,void 0,void 0,(function*(){this.enabled&&(yield this.MaxTemperatureChanged.trigger({device:t,temperature:i,zone:e}))}))}onMinUpdated(e,t,i){return n(this,void 0,void 0,(function*(){this.enabled&&(yield this.MinTemperatureChanged.trigger({device:t,temperature:i,zone:e}))}))}onTooWarm(e,t){return n(this,void 0,void 0,(function*(){this.enabled&&(yield this.TooWarm.trigger({temperature:t,zone:e}))}))}onTooCold(e,t){return n(this,void 0,void 0,(function*(){this.enabled&&(yield this.TooCold.trigger({temperature:t,zone:e}))}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(6);t.Zones=class{constructor(e){this.manager=e,this.zones={},this.zonesIgnored=[],this.zonesNotMonitored=[],this.devicesIgnored=[]}addZone(e,t){if(e in this.zones)return this.zones[e];const i=new r.Zone(this.manager,e,t,this.zonesIgnored.includes(e),this.zonesNotMonitored.includes(e),this.devicesIgnored);return this.zones[e]=i,i}removeDeviceById(e){return n(this,void 0,void 0,(function*(){for(const t in this.zones)yield this.zones[t].removeDevice(e)}))}getAll(){return this.zones}updateDevices(e,t,i){return n(this,void 0,void 0,(function*(){if(this.zonesIgnored!==e){this.zonesIgnored=e;for(const e in this.zones)yield this.zones[e].setIgnored(this.zonesIgnored.includes(e))}if(this.zonesNotMonitored!==t){this.zonesNotMonitored=t;for(const e in this.zones)yield this.zones[e].setNotMonitored(this.zonesNotMonitored.includes(e))}if(this.devicesIgnored!==i){this.devicesIgnored=i;for(const e in this.zones)yield this.zones[e].setDevicesIgnored(this.devicesIgnored)}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(7);t.Zone=class{constructor(e,t,i,n,r,o){this.manager=e,this.id=t,this.name=i,this.devices=[],this.minTemp=void 0,this.minSensor=void 0,this.maxTemp=void 0,this.maxSensor=void 0,this.current=void 0,this.minAllowed=e.getMinTemp(),this.maxAllowed=e.getMaxTemp(),this.ignored=n,this.notMonitored=r,this.devicesIgnored=o}getId(){return this.id}getName(){return this.name}getTemperature(){return this.current}getMin(){return this.minTemp}getMax(){return this.maxTemp}addDevice(e){return n(this,void 0,void 0,(function*(){const t=new r.Thermometer(e,this.devicesIgnored.includes(e.id));this.devices.push(t),yield this.calculateZoneTemp(),t.hasTemp()&&this.updateTemp(t.id,t.temp)}))}removeDevice(e){return n(this,void 0,void 0,(function*(){for(let t=0;t<this.devices.length;t++)if(this.devices[t].id===e)return this.devices.splice(t,1),void(yield this.calculateZoneTemp())}))}setIgnored(e){return n(this,void 0,void 0,(function*(){this.ignored!==e&&(this.ignored=e,yield this.calculateZoneTemp())}))}setNotMonitored(e){this.notMonitored=e}setDevicesIgnored(e){this.devicesIgnored=e;for(const e of this.devices)e.setIgnored(this.devicesIgnored.includes(e.id))}resetMaxMin(){this.minTemp=void 0,this.maxTemp=void 0}updateTemp(e,t){return n(this,void 0,void 0,(function*(){if(this.ignored)return;const i=this.findDevice(e);if(i){if(i.update(t)&&(yield this.calculateZoneTemp()),void 0===this.minTemp)this.onMinUpdated(i.name,t);else{const e=Math.min(this.minTemp,t);this.minTemp!==e&&this.onMinUpdated(i.name,t)}if(void 0===this.maxTemp)this.onMaxUpdated(i.name,t);else{const e=Math.max(this.maxTemp,t);this.maxTemp!==e&&this.onMaxUpdated(i.name,t)}}else console.error("Failed to find device: "+e)}))}findDevice(e){for(const t of this.devices)if(t.id===e)return t}calculateZoneTemp(){return n(this,void 0,void 0,(function*(){if(this.ignored)return;let e=0,t=0;for(const i of this.devices)i.hasTemp()&&(e+=i.temp,t++);if(t>0){const i=Math.round(e/t*10)/10;i!==this.current&&(this.current=i,yield this.onTempUpdated())}else this.current=void 0}))}onMaxUpdated(e,t){this.maxTemp=t,this.maxSensor=e,this.manager.getTriggers().onMaxUpdated(this.name,e,this.maxTemp)}onMinUpdated(e,t){this.minTemp=t,this.minSensor=e,this.manager.getTriggers().onMinUpdated(this.name,e,this.minTemp)}onTempUpdated(){return n(this,void 0,void 0,(function*(){this.notMonitored?yield this.manager.getTriggers().onTempUpdated(this.name,this.current):this.current>this.maxAllowed?this.manager.getTriggers().onTooWarm(this.name,this.current):this.current<this.minAllowed?this.manager.getTriggers().onTooCold(this.name,this.current):yield this.manager.getTriggers().onTempUpdated(this.name,this.current)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Thermometer=class{constructor(e,t){this.device=e,this.id=e.id,this.name=e.name,this.zone=e.ZoneName,this.temp=e.capabilitiesObj.measure_temperature.value,this.ignored=t}getName(){return this.name}getZone(){return this.zone}update(e){return this.temp!==e&&(this.temp=e,!0)}setIgnored(e){this.ignored=e}hasTemp(){return!this.ignored&&void 0!==this.temp}}}])}));